"use strict";(()=>{var e={};e.id=3561,e.ids=[3561],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},27290:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>k,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>_,serverHooks:()=>x,staticGenerationAsyncStorage:()=>q,staticGenerationBailout:()=>g});var a={};r.r(a),r.d(a,{POST:()=>h});var s=r(95419),n=r(69108),i=r(99678),o=r(78070),u=r(53524),c=r(7439),d=r(46082),p=r.n(d);let l=new u.PrismaClient,m=process.env.JWT_SECRET||"super-secret-key-change-this";async function h(e){try{let t;let r=c.cookies().get("token")?.value;if(!r)return o.Z.json({message:"Unauthorized"},{status:401});try{t=p().verify(r,m).userId}catch(e){return o.Z.json({message:"Invalid token"},{status:401})}let{items:a,paymentMethod:s,subtotal:n,tax:i,discount:u,total:d,customerId:h}=await e.json();if(!a||0===a.length)return o.Z.json({message:"Cart is empty"},{status:400});let _=await l.$transaction(async e=>{let r=await e.sale.create({data:{user_id:t,branch_id:1,customer_id:h||null,total_amount:d,discount:u||0,tax:i||0,payment_method:s||"Cash",status:"completed",sale_date:new Date,invoice_number:"INV-"+Date.now()}});for(let s of a){let a=await e.inventory.findUnique({where:{product_id_branch_id:{product_id:s.productId,branch_id:1}}});if(!a||a.quantity<s.quantity)throw Error(`Insufficient stock for product ${s.name}`);let n=s.price*s.quantity-(s.discount||0);await e.saleItem.create({data:{sale_id:r.sale_id,product_id:s.productId,quantity:s.quantity,unit_price:s.price,discount:s.discount||0,subtotal:n}}),await e.inventory.update({where:{product_id_branch_id:{product_id:s.productId,branch_id:1}},data:{quantity:{decrement:s.quantity}}}),await e.stockMovement.create({data:{product_id:s.productId,branch_id:1,type:"SALE",quantity:-s.quantity,reference_id:r.sale_id,user_id:t,date:new Date}})}return r});return o.Z.json({message:"Sale completed successfully",saleId:_.sale_id},{status:201})}catch(e){return console.error("Checkout error:",e),o.Z.json({message:e.message||"Transaction failed"},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sales/checkout/route",pathname:"/api/sales/checkout",filename:"route",bundlePath:"app/api/sales/checkout/route"},resolvedPagePath:"C:\\Users\\mubar\\Desktop\\MADAR\\app\\api\\sales\\checkout\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:q,serverHooks:x,headerHooks:f,staticGenerationBailout:g}=_,k="/api/sales/checkout/route";function v(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:q})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7439,6082],()=>r(27290));module.exports=a})();