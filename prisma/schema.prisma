// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id       Int       @id @default(autoincrement())
  full_name     String
  username      String    @unique
  email         String    @unique
  password_hash String
  role_id       Int
  status        String    @default("active") // active, inactive
  created_at    DateTime  @default(now())
  
  role          Role      @relation(fields: [role_id], references: [role_id])
  sales         Sale[]
  purchases     Purchase[]
  stock_movements StockMovement[]
}

model Role {
  role_id     Int       @id @default(autoincrement())
  role_name   String    @unique // Admin, Cashier, Manager
  description String?
  
  users             User[]
  role_permissions  RolePermission[]
}

model Permission {
  permission_id   Int       @id @default(autoincrement())
  permission_name String    @unique
  
  role_permissions RolePermission[]
}

model RolePermission {
  id            Int       @id @default(autoincrement())
  role_id       Int
  permission_id Int
  
  role          Role       @relation(fields: [role_id], references: [role_id])
  permission    Permission @relation(fields: [permission_id], references: [permission_id])
}

model Branch {
  branch_id   Int       @id @default(autoincrement())
  branch_name String
  location    String?
  phone       String?
  
  inventory       Inventory[]
  sales           Sale[]
  purchases       Purchase[]
  stock_movements StockMovement[]
}

model Category {
  category_id   Int       @id @default(autoincrement())
  category_name String
  description   String?
  
  products      Product[]
}

model Product {
  product_id    Int       @id @default(autoincrement())
  name          String
  sku           String    @unique // or barcode
  category_id   Int
  cost_price    Decimal
  selling_price Decimal
  description   String?
  image_url     String?
  status        String    @default("active")
  created_at    DateTime  @default(now())
  
  category      Category  @relation(fields: [category_id], references: [category_id])
  variants      ProductVariant[]
  inventory     Inventory[]
  stock_movements StockMovement[]
  sale_items    SaleItem[]
  purchase_items PurchaseItem[]
}

model ProductVariant {
  variant_id       Int     @id @default(autoincrement())
  product_id       Int
  size             String?
  color            String?
  additional_price Decimal @default(0)
  
  product          Product @relation(fields: [product_id], references: [product_id])
}

model Inventory {
  inventory_id  Int      @id @default(autoincrement())
  product_id    Int
  branch_id     Int
  quantity      Int      @default(0)
  reorder_level Int      @default(10)
  last_updated  DateTime @updatedAt
  
  product       Product  @relation(fields: [product_id], references: [product_id])
  branch        Branch   @relation(fields: [branch_id], references: [branch_id])

  @@unique([product_id, branch_id])
}

model StockMovement {
  movement_id   Int      @id @default(autoincrement())
  product_id    Int
  branch_id     Int
  type          String   // Sale, Purchase, Adjustment, Transfer
  quantity      Int
  reference_id  Int?
  date          DateTime @default(now())
  user_id       Int
  
  product       Product  @relation(fields: [product_id], references: [product_id])
  branch        Branch   @relation(fields: [branch_id], references: [branch_id])
  user          User     @relation(fields: [user_id], references: [user_id])
}

model Customer {
  customer_id Int      @id @default(autoincrement())
  full_name   String
  phone       String?
  email       String?
  address     String?
  balance     Decimal  @default(0)
  created_at  DateTime @default(now())
  
  sales       Sale[]
}

model Supplier {
  supplier_id   Int      @id @default(autoincrement())
  name          String
  company_name  String?
  phone         String?
  email         String?
  address       String?
  balance       Decimal  @default(0)
  created_at    DateTime @default(now())
  
  purchases     Purchase[]
}

model Sale {
  sale_id        Int      @id @default(autoincrement())
  invoice_number String   @unique
  customer_id    Int?
  user_id        Int
  branch_id      Int
  total_amount   Decimal
  discount       Decimal  @default(0)
  tax            Decimal  @default(0)
  paid_amount    Decimal  @default(0)
  payment_method String?
  sale_date      DateTime @default(now())
  status         String   @default("completed")
  
  customer       Customer? @relation(fields: [customer_id], references: [customer_id])
  user           User      @relation(fields: [user_id], references: [user_id])
  branch         Branch    @relation(fields: [branch_id], references: [branch_id])
  sale_items     SaleItem[]
}

model SaleItem {
  sale_item_id Int     @id @default(autoincrement())
  sale_id      Int
  product_id   Int
  quantity     Int
  unit_price   Decimal
  discount     Decimal @default(0)
  subtotal     Decimal
  
  sale         Sale    @relation(fields: [sale_id], references: [sale_id])
  product      Product @relation(fields: [product_id], references: [product_id])
}

model Purchase {
  purchase_id    Int      @id @default(autoincrement())
  supplier_id    Int
  user_id        Int
  branch_id      Int
  total_amount   Decimal
  paid_amount    Decimal  @default(0)
  payment_method String?
  purchase_date  DateTime @default(now())
  status         String   @default("completed")
  
  supplier       Supplier @relation(fields: [supplier_id], references: [supplier_id])
  user           User     @relation(fields: [user_id], references: [user_id])
  branch         Branch   @relation(fields: [branch_id], references: [branch_id])
  purchase_items PurchaseItem[]
}

model PurchaseItem {
  purchase_item_id Int     @id @default(autoincrement())
  purchase_id      Int
  product_id       Int
  quantity         Int
  unit_cost        Decimal
  subtotal         Decimal
  
  purchase         Purchase @relation(fields: [purchase_id], references: [purchase_id])
  product          Product  @relation(fields: [product_id], references: [product_id])
}

model Payment {
  payment_id     Int      @id @default(autoincrement())
  reference_type String
  reference_id   Int
  amount         Decimal
  payment_method String
  date           DateTime @default(now())
}

model Return {
  return_id      Int      @id @default(autoincrement())
  reference_type String
  reference_id   Int
  date           DateTime @default(now())
  total_amount   Decimal
  reason         String?
}

model Setting {
  setting_id  Int     @id @default(autoincrement())
  system_name String
  currency    String  @default("USD")
  tax_rate    Decimal @default(0)
  logo        String?
  backup_path String?
}
